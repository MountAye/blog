<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">



<title>.py | import 引用现成的代码 | 阿掖山：一个博客</title>
<link rel="shortcut icon" href="https://mountaye.github.io/blog/favicon.ico" >
<link rel="canonical" href="https://mountaye.github.io/blog/articles/python-import-script-module-package" />
<meta name="generator" content="Jekyll v4.3.2" />
<meta name="author" content="MountAye" />
<meta name="description" content="正常的编程语言教程，教人配置完开发环境之后就应该进入正题，开始讲语法了。但是咱不正常，所以先来谈谈怎么用别人已经写好的代码。" />
<meta property="og:title" content=".py | import 引用现成的代码" />
<meta property="og:locale" content="zh-CN" />
<meta property="og:description" content="" />
<meta property="og:url" content="https://mountaye.github.io/blog/articles/python-import-script-module-package" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-12-11 00:00:00 +0800" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content=".py | import 引用现成的代码" />
<script type="application/ld+json">
    {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"MountAye"},"dateModified":"","datePublished":"2021-12-11","description":"正常的编程语言教程，教人配置完开发环境之后就应该进入正题，开始讲语法了。但是咱不正常，所以先来谈谈怎么用别人已经写好的代码。","headline":"正常的编程语言教程，教人配置完开发环境之后就应该进入正题，开始讲语法了。但是咱不正常，所以先来谈谈怎么用别人已经写好的代码。","mainEntityOfPage":{"@type":"WebPage","@id":""},"url":"https://mountaye.github.io/blog/articles/python-import-script-module-package"}
</script>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3X9B5LN42L"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3X9B5LN42L');
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1920275466226790"
     crossorigin="anonymous"></script>

    <link rel="stylesheet" href="/blog/assets/css/style.css?v=">
    <script src="https://code.jquery.com/jquery-3.3.0.min.js" integrity="sha256-RTQy8VOmNlT6b2PIRur37p6JEBZUE7o8wPgMvu18MC4=" crossorigin="anonymous"></script>
    <script src="/blog/assets/js/main.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!--[if lt IE 9]>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" integrity="sha256-3Jy/GbSLrg0o9y5Z5n1uw0qxZECH7C6OQpVBgNFYa0g=" crossorigin="anonymous"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  </head>
  <body>
    <header>
      <a href="/blog/"><h1>阿掖山：一个博客</h1></a>
      <p>智力活动是一种生活态度</p>
    </header>
    <div id="banner">
      <span id="logo"></span>
      <span class="button fork">
        <a href="/blog/articles/python-import-script-module-package"><strong>汉</strong></a> | 
        <a href="/blog/en/articles/python-import-script-module-package"><strong>En</strong></a>
      </span>
      <div class="downloads">
        <span></span>
        <ul>
          <li><a href="/blog/history" class="button">历史</a></li>
          <li><a href="/blog/topics" class="button">分类</a></li>
          <li><a href="/blog/about" class="button">关于</a></li>
        </ul>
      </div>
    </div>

    <div class="wrapper">
      <nav>
        <ul></ul>
      </nav>
      <section id="ad-head"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1920275466226790"
     crossorigin="anonymous"></script>
<!-- blog-header -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-1920275466226790"
     data-ad-slot="4291489170"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script></section>
<section class="outlined">
  <h1>.py | import 引用现成的代码</h1>
  <p style="text-indent: 0;">2021 年 12 月 11 日 </p>
  <p style="text-indent: 0;"><code>.md</code><code>.py</code></p>
  
  <hr>
  <p>以官网给出的文件结构为例来说明：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
sound/                          Top-level package
      __init__.py               Initialize the sound package
      formats/                  Subpackage for file format conversions
              __init__.py
              wavread.py
              wavwrite.py
              aiffread.py
              aiffwrite.py
              auread.py
              auwrite.py
              ...
      effects/                  Subpackage for sound effects
              __init__.py
              echo.py
              surround.py
              reverse.py
              ...
      filters/                  Subpackage for filters
              __init__.py
              equalizer.py
              vocoder.py
              karaoke.py
              ...
</code></pre></div></div>

<h2 id="使用现成的-python-代码">使用现成的 python 代码</h2>

<p>正常的编程语言教程，教人配置完开发环境之后就应该进入正题，开始讲语法了。但是咱不正常，所以先来谈谈怎么用别人已经写好的代码。其中最简单的，就是可以直接通过包管理程序安装的：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
pip <span class="nb">install </span>sound
</code></pre></div></div>

<p>然后想要使用某个文件中的函数，比如假装 <code class="language-plaintext highlighter-rouge">wavwrite.py</code> 中有个函数叫 <code class="language-plaintext highlighter-rouge">write()</code>，以下写法都是可以的，注意不同 import 方法对应不同的函数调用写法：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">import</span> <span class="n">sound</span>
<span class="n">sound</span><span class="p">.</span><span class="n">formats</span><span class="p">.</span><span class="n">wavwrite</span><span class="p">.</span><span class="nf">write</span><span class="p">()</span>

<span class="kn">from</span> <span class="n">sound</span> <span class="kn">import</span> <span class="n">formats</span>
<span class="n">formats</span><span class="p">.</span><span class="n">wavwrite</span><span class="p">.</span><span class="nf">write</span><span class="p">()</span> 

<span class="kn">from</span> <span class="n">sound.formats</span> <span class="kn">import</span> <span class="n">wavwrite</span>
<span class="n">wavwrite</span><span class="p">.</span><span class="nf">write</span><span class="p">()</span>

<span class="kn">from</span> <span class="n">sound.formats.wavwrite</span> <span class="kn">import</span> <span class="n">write</span>
<span class="nf">write</span><span class="p">()</span>
</code></pre></div></div>

<p>但是，不是所有的 python 代码都可以直接安装，比如一篇论文的研究成果发表之后，处理数据的代码也往往开源，但是这些作者基本上就只是把自己写代码的文件夹公开出来而已，我们把文件夹下载下来，然后直接 <code class="language-plaintext highlighter-rouge">import sound</code>, 会报错，提示找不到名为 sound 的库。</p>

<h2 id="python-如何读取代码文件">python 如何读取代码文件</h2>

<p>仔细想想，找不到才是正常的，之前轻轻松松的一句 <code class="language-plaintext highlighter-rouge">import sound</code>就解决问题，这才不简单——不同的库往往位于文件系统的不同位置，但我们只要写出他们的名字就行了，不需要指定文件路径。电脑硬盘那么大，找到库却几乎是瞬间完成的。</p>

<p>这是因为 python 并没有搜索整个硬盘。有一个变量，一般名为 <code class="language-plaintext highlighter-rouge">PYTHONPATH</code>，其变量值是一个列表，表中成员是含有 python 库文件夹的路径。当我们在命令行输入命令的时候，电脑会：</p>

<ul>
  <li>搜索当前所在的文件夹，也就是在命令行输入 <code class="language-plaintext highlighter-rouge">python</code> 时终端所在的文件夹。</li>
  <li>遍历 <code class="language-plaintext highlighter-rouge">PYTHONPATH</code> 中的文件夹。</li>
  <li>python 包管理程序默认的位置，一般是 <code class="language-plaintext highlighter-rouge">&lt;path to python&gt;/site-package</code>。</li>
</ul>

<p>看看有没有我们要引用的库，找到了就引入，找不到就报错。</p>

<p>上一节的错误中，如果我们恰好位于 sound 所在的文件夹，然后运行 python，此时第一条生效， <code class="language-plaintext highlighter-rouge">import sound</code> 不会报错，但在其他位置就不行了。</p>

<h2 id="名词解释interactive-script-module-package">名词解释：interactive, script, module, package</h2>

<p>可执行的 python 命令可以出现在以下四个地方，第一种是接受键盘输入的程序，后三种都是文件：</p>

<ol>
  <li>interactive: python <strong>交互式界面</strong>，也叫做 calculator mode，也就是在命令行输入 <code class="language-plaintext highlighter-rouge">python</code>之后出现的界面。每次输入一句，结果在命令行上显示出来。当 python 退出之后，输入过的命令就消失了。</li>
  <li>script: python <strong>脚本</strong>文件，也就是在命令行输入 <code class="language-plaintext highlighter-rouge">python somefile.py</code>里面的那个<code class="language-plaintext highlighter-rouge">somefile.py</code>。
    <ol>
      <li>毕竟 python 是一种很轻量化的语言，在一定程度上可以起到 shell 的作用，有些命令我们并不想要用完就扔，而是保存起来以便以后重复执行，另外很多命令的组合组合成函数也可以极大地简化工作。在这种语境之下, interactive 和 script 的关系，就好像 Linux 命令行和 bash script 的关系一样。</li>
      <li>但同时 python 又是一种功能很全面的语言，完全可以胜任复杂的面向对象编程。在这种语境之下，script 也可以用来指代 main module，也就是程序执行的主文件和入口，和下面的一般的 module 相区分。</li>
    </ol>
  </li>
  <li>module: python <strong>模块</strong>文件，也就是在命令行输入 <code class="language-plaintext highlighter-rouge">python -m another</code> 里面的那个 <code class="language-plaintext highlighter-rouge">another</code>（注意这里不写拓展名 <code class="language-plaintext highlighter-rouge">.py</code>）。按照官方文档的说法，所有 <code class="language-plaintext highlighter-rouge">.py</code> 文件都是 module。但是实际上这句话很有误导性，上一节的 main module 和一般的 module 非常不同，下一节会详细展开讲。一般提到 module，都是在强调这个文件定义的变量和函数可以被其他的 python 文件引用。</li>
  <li>package: python <strong>包</strong>，互相关联的 modules 构成的更高一级的可供引用的结构，简单理解就是含有 <code class="language-plaintext highlighter-rouge">__init__.py</code> 的文件夹，但是 python 并不是根据文件夹和文件之间的从属关系来确定 package 和 module 之间的关系的，下一节会详细展开讲。</li>
</ol>

<h2 id="script-vs-module">script vs. module</h2>

<p>python 同时兼具脚本语言的灵活性，和各种重型语言的功能全面性。因为前者，所以它并不要求程序作者一定要在一个叫做 <code class="language-plaintext highlighter-rouge">main.py</code> 的文件里写一个名叫 <code class="language-plaintext highlighter-rouge">Main</code> 的类, 然后在里面实现一个 <code class="language-plaintext highlighter-rouge">main()</code> 方法。但是因为后者，没写不代表 python 不需要知道一个复杂程序执行的起点。</p>

<p>这个起点就是不带有 <code class="language-plaintext highlighter-rouge">-m</code> 参数的 <code class="language-plaintext highlighter-rouge">python</code> 命令后面跟着的 <code class="language-plaintext highlighter-rouge">.py</code> 文件，这就使得这个文件变得比其他 <code class="language-plaintext highlighter-rouge">.py</code> 文件特殊。底层表现就是 python 会不管这个文件的名字叫什么，都将它的 <code class="language-plaintext highlighter-rouge">__name__</code> 属性赋值为 <code class="language-plaintext highlighter-rouge">"__main__"</code>。这样，即便这个文件可能是一个大型库中间的一个模块，运行的时候 python 连它的真名都不知道，就更找不到它同级和上下级的其他模块了。</p>

<p>各种普通模块被 python 用到的方法就是通过在主模块 main module（或者说 script）中 import。经过“python 如何读取代码文件”一节中的搜索过程之后找到了所需模块或包，模块的名字、模块之间的关系、模块里定义了哪些属性和函数，就被 python 了解了，从而当主模块召唤他们的时候就知道去哪里找相应的代码。除了在被 import 的时候，<code class="language-plaintext highlighter-rouge">python -m</code> 命令的宾语也可以告诉 python 被运行的模块和包的相对关系：<code class="language-plaintext highlighter-rouge">python -m sound.formats.wavwrite</code> ，此时 python 执行了 <code class="language-plaintext highlighter-rouge">wavwrite.py</code> 中的所有可执行的命令，同时知道从 <code class="language-plaintext highlighter-rouge">sound/</code> 到 <code class="language-plaintext highlighter-rouge">wavwrite.py</code> 的各个包之间的关系。</p>

<h2 id="absolute-import-vs-relative-import">absolute import vs. relative import</h2>

<p>开头使用已经安装过的包使用的语法全都是绝对引用 (absolute import)，表现就是 import 语句里面没有以 <code class="language-plaintext highlighter-rouge">.</code> 作为开头的。</p>

<p>另外一种 import 方法叫相对引用 (relative import)，<code class="language-plaintext highlighter-rouge">.</code> 表示模块所在的文件夹，<code class="language-plaintext highlighter-rouge">..</code> 表示模块的上一级文件夹。主要用在各种明确知道自己是工具代码，而且是一个更高层次结构的组成部分，几乎永远不需要被作为主模块运行的代码。</p>

<p>回到开头例子里的文件结构，假如 sound/effects/surround.py 中想要使用 sound/formats/wavwrite.py 和 sound/effects/echo.py 中的函数，可以写成：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># in sound/effects/surround.py
</span><span class="kn">from</span> <span class="n">..formats</span> <span class="kn">import</span> <span class="n">wavwrite</span>
<span class="kn">from</span> <span class="n">.</span> <span class="kn">import</span> <span class="n">echo</span>
</code></pre></div></div>

<h2 id="如何组织代码以便自己重用">如何组织代码，以便自己重用</h2>

<p>研究终于推进到了准备写论文的阶段了（学渣本质暴露了），写草稿之余，之前几年时间里做过的处理和分析，接下来的一两个月里需要把工作流程规范化之后迅速重做一遍确认。</p>

<p>随手写散落各处的分析代码需要整理到一起，之前试图统一到一个项目之下，结果总是在某个模块引用其他模块的时候遇到报错。于是才有了这篇文章。</p>

<p>以下是 <a href="https://gist.github.com/ericmjl/27e50331f24db3e8f957d1fe7bbbe510">这篇文章</a> 给出的一个推荐的项目文件结构：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
|- notebooks/
   |- 01-first-logical-notebook.ipynb
   |- 02-second-logical-notebook.ipynb
   |- prototype-notebook.ipynb
   |- archive/
	  |- no-longer-useful.ipynb
|- projectname/
   |- projectname/
	  |- __init__.py
	  |- config.py
	  |- data.py
	  |- utils.py
   |- setup.py
|- README.md
|- data/
   |- raw/
   |- processed/
   |- cleaned/
|- scripts/
   |- script1.py
   |- script2.py
   |- archive/
      |- no-longer-useful.py
|- environment.yml
</code></pre></div></div>

<p>学过这篇笔记包含的内容，我才理解作者这样的安排。既然主文件 <del>很难</del> 没办法通过相对引用来找到工具代码，索性就把工具代码写成一个完整可安装的库，然后就像 <code class="language-plaintext highlighter-rouge">numpy</code>, <code class="language-plaintext highlighter-rouge">pandas</code> 一样在独立的 notebook 和 scripts 中引用。</p>

<p>实际使用的时候，需要安装 <code class="language-plaintext highlighter-rouge">projectname</code> 下的代码：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>projectname
pip <span class="nb">install</span> <span class="nt">-e</span> <span class="nb">.</span>
</code></pre></div></div>

<p>要知道为什么这样做，需要理解 <code class="language-plaintext highlighter-rouge">setup.py</code> 这个文件。这篇文章已经够长了，所以这个话题还是下次再说吧。</p>

<h2 id="参考链接">参考链接</h2>

<ul>
  <li><a href="https://stackoverflow.com/questions/7948494/whats-the-difference-between-a-python-module-and-a-python-package">What’s the difference between a Python module and a Python package?</a>. all python files re modules, while package is a specific kind of modules. It is a subsection of module in the python documentation.</li>
  <li>Official explanation of python module: <a href="https://docs.python.org/3/tutorial/modules.html">https://docs.python.org/3/tutorial/modules.html</a></li>
  <li><a href="https://stackoverflow.com/questions/14132789/relative-imports-for-the-billionth-time">This stackoverflow  answer: “run as module” is different from “run as script”.</a> run as module sets the “name” to the module’s name, while running as script sets it to <code class="language-plaintext highlighter-rouge">__main__</code> . Here we use “name” instead of <code class="language-plaintext highlighter-rouge">__name__</code> because it also contains <code class="language-plaintext highlighter-rouge">__path__</code> in newer versions.</li>
  <li>A tutorial for project organization: <a href="https://realpython.com/python-application-layouts/">https://realpython.com/python-application-layouts/</a></li>
  <li>Official about packaging: <a href="https://packaging.python.org/en/latest/tutorials/packaging-projects/">https://packaging.python.org/en/latest/tutorials/packaging-projects/</a></li>
  <li>Gist: How to organize data science project: <a href="https://gist.github.com/ericmjl/27e50331f24db3e8f957d1fe7bbbe510">https://gist.github.com/ericmjl/27e50331f24db3e8f957d1fe7bbbe510</a></li>
  <li>From the gist there is a link: <a href="http://drivendata.github.io/cookiecutter-data-science">http://drivendata.github.io/cookiecutter-data-science</a></li>
</ul>

  <hr>
</section>
<section id="ad-tail"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1920275466226790"
     crossorigin="anonymous"></script>
<!-- blog-header -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-1920275466226790"
     data-ad-slot="4291489170"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script></section>
<section id="comments">
  <script src="https://giscus.app/client.js"
        data-repo="MountAye/comments"
        data-repo-id="R_kgDOJe4FmQ"
        data-category="BLOG"
        data-category-id="DIC_kwDOJe4Fmc4CWQuC"
        data-mapping="title"
        data-strict="1"
        data-reactions-enabled="1"
        data-emit-metadata="1"
        data-input-position="bottom"
        data-theme="light"
        data-lang="zh-CN"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>
</section>

    </div>
    <footer>
      <p><small>Hosted on GitHub Pages
            <br>Theme by <a href="https://twitter.com/mattgraham">mattgraham</a>
            <br>Modified by <a href="https://www.github.com/MountAye">MountAye</a>
      </small></p>
    </footer>

  </body>
</html>

  